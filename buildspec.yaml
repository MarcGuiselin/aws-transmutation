# Buildspec for deploying changes
version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: latest
      python: latest
    commands:
      # Need cfn-lint for template lint check
      - pip install cfn-lint
      # Install yarn for linking dependencies
      - npm i -g yarn
      # Install dependencies for github-status-update
      - cd src/github-status-update
      - yarn install
      - cd ../..
      # Install dependencies for github-webhooks
      - cd src/github-webhooks
      - yarn install
      - cd ../..
  build:
    commands:
      # Template lint check
      - cfn-lint -t src/template.yaml
      - cfn-lint -t src/pipeline.yaml
      # Package templates
      - >
        sam package \
          --template-file src/template.yaml \
          --output-template-file packaged-template.yaml \
          --s3-bucket $PIPELINE_BUCKET
      - >
        sam package \
          --template-file src/pipeline.yaml \
          --output-template-file packaged-pipeline.yaml \
          --s3-bucket $PIPELINE_BUCKET
      # Upload templates
      - aws s3 cp packaged-template.yaml "s3://$PIPELINE_BUCKET/template.yaml" 
      - aws s3 cp packaged-pipeline.yaml "s3://$PIPELINE_BUCKET/pipeline.yaml" 